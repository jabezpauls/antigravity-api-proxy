<div x-data="{
    activeTab: 'ui'
}" class="view-container">
    <!-- Header & Tabs -->
    <div class="view-card !p-0 flex flex-col overflow-hidden">
        <div class="bg-space-900/50 border-b border-space-border px-8 pt-8 pb-0 shrink-0">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-neon-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span x-text="$store.global.t('systemConfig')">System Configuration</span>
                </h3>
            </div>

            <div class="flex gap-6 overflow-x-auto">
                <button @click="activeTab = 'ui'"
                    class="pb-3 border-b-2 transition-colors font-medium text-sm flex items-center gap-2 whitespace-nowrap"
                    :class="activeTab === 'ui' ? 'border-neon-purple text-white' : 'border-transparent text-gray-500 hover:text-gray-300'">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                    </svg>
                    <span x-text="$store.global.t('tabInterface')">Interface</span>
                </button>
                <button @click="activeTab = 'server'"
                    class="pb-3 border-b-2 transition-colors font-medium text-sm flex items-center gap-2 whitespace-nowrap"
                    :class="activeTab === 'server' ? 'border-neon-purple text-white' : 'border-transparent text-gray-500 hover:text-gray-300'">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                    </svg>
                    <span x-text="$store.global.t('tabServer')">Server</span>
                </button>
                <button @click="activeTab = 'apikeys'"
                    class="pb-3 border-b-2 transition-colors font-medium text-sm flex items-center gap-2 whitespace-nowrap"
                    :class="activeTab === 'apikeys' ? 'border-neon-purple text-white' : 'border-transparent text-gray-500 hover:text-gray-300'">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                    </svg>
                    <span>API Keys</span>
                </button>
            </div>
        </div>

        <!-- Scrollable Content -->
        <div class="p-8 overflow-y-auto flex-1 custom-scrollbar">

            <!-- Tab 1: UI Preferences -->
            <div x-show="activeTab === 'ui'" class="space-y-8 max-w-2xl animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Language -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text text-gray-300" x-text="$store.global.t('language')">Language</span>
                        </label>
                        <select
                            class="select select-bordered select-sm w-full bg-space-800 border-space-border/50 text-gray-300 focus:border-neon-purple focus:ring-1 focus:ring-neon-purple/50 font-medium transition-all !py-0 leading-tight"
                            :value="$store.global.lang"
                            @change="$store.global.setLang($event.target.value)">
                            <option value="en">English</option>
                            <option value="zh">ä¸­æ–‡</option>
                            <option value="tr">TÃ¼rkÃ§e</option>
                            <option value="id">Bahasa Indonesia</option>
                            <option value="pt">PortuguÃªs (BR)</option>
                        </select>
                    </div>

                    <!-- Polling Interval -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text text-gray-300" x-text="$store.global.t('pollingInterval')">Polling
                                Interval</span>
                            <span class="label-text-alt font-mono text-neon-purple"
                                x-text="$store.settings.refreshInterval + 's'"></span>
                        </label>
                        <div class="flex gap-3 items-center">
                            <input type="range" min="10" max="300" class="custom-range custom-range-purple flex-1"
                                x-model.number="$store.settings.refreshInterval"
                                :style="`background-size: ${($store.settings.refreshInterval - 10) / 2.9}% 100%`"
                                @change="$store.settings.saveSettings(true)"
                                aria-label="Polling interval slider">
                            <input type="number" min="10" max="300"
                                class="input input-sm input-bordered w-20 bg-space-800 border-space-border text-white font-mono text-center"
                                x-model.number="$store.settings.refreshInterval"
                                @change="$store.settings.saveSettings(true)"
                                aria-label="Polling interval value">
                        </div>
                        <div class="w-full flex justify-between text-xs px-2 mt-2 text-gray-600 font-mono">
                            <span>10s</span>
                            <span>300s</span>
                        </div>
                    </div>

                    <!-- Log Buffer -->
                    <div class="form-control col-span-full">
                        <label class="label">
                            <span class="label-text text-gray-300" x-text="$store.global.t('maxDisplayLogs')">Log Buffer
                                Size</span>
                            <span class="label-text-alt font-mono text-neon-purple"
                                x-text="$store.settings.logLimit + ' ' + $store.global.t('lines')"></span>
                        </label>
                        <div class="flex gap-3 items-center">
                            <input type="range" min="500" max="5000" step="500" class="custom-range custom-range-purple flex-1"
                                x-model.number="$store.settings.logLimit"
                                :style="`background-size: ${($store.settings.logLimit - 500) / 45}% 100%`"
                                @change="$store.settings.saveSettings(true)"
                                aria-label="Log buffer size slider">
                            <input type="number" min="500" max="5000" step="500"
                                class="input input-sm input-bordered w-24 bg-space-800 border-space-border text-white font-mono text-center"
                                x-model.number="$store.settings.logLimit"
                                @change="$store.settings.saveSettings(true)"
                                aria-label="Log buffer size value">
                        </div>
                        <div class="w-full flex justify-between text-xs px-2 mt-2 text-gray-600 font-mono">
                            <span>500</span>
                            <span>5000</span>
                        </div>
                    </div>
                </div>

                <div class="divider border-space-border/50"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control bg-space-900/50 p-4 rounded-lg border transition-all duration-300 hover:border-neon-purple/50"
                        :class="$store.settings.showExhausted ? 'border-neon-purple/50 bg-neon-purple/5 shadow-[0_0_15px_rgba(168,85,247,0.1)]' : 'border-space-border/50'">
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col gap-1">
                                <span class="label-text font-medium transition-colors"
                                    :class="$store.settings.showExhausted ? 'text-neon-purple' : 'text-gray-300'"
                                    x-text="$store.global.t('showExhausted')">Show Exhausted Models</span>
                                <span class="text-xs text-gray-500"
                                    x-text="$store.global.t('showExhaustedDesc')">Display models even if they have 0%
                                    remaining quota.</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer"
                                    :checked="$store.settings.showExhausted === true"
                                    @change="$store.settings.showExhausted = $event.target.checked; $store.settings.saveSettings(true)"
                                    aria-label="Show exhausted models toggle">
                                <div
                                    class="w-9 h-5 bg-space-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-gray-600 after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-neon-purple peer-checked:after:bg-white">
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="form-control bg-space-900/50 p-4 rounded-lg border transition-all duration-300 hover:border-neon-green/50"
                        :class="$store.settings.compact ? 'border-neon-green/50 bg-neon-green/5 shadow-[0_0_15px_rgba(34,197,94,0.1)]' : 'border-space-border/50'">
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col gap-1">
                                <span class="label-text font-medium transition-colors"
                                    :class="$store.settings.compact ? 'text-neon-green' : 'text-gray-300'"
                                    x-text="$store.global.t('compactMode')">Compact Mode</span>
                                <span class="text-xs text-gray-500" x-text="$store.global.t('compactModeDesc')">Reduce
                                    padding in tables for higher information density.</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" :checked="$store.settings.compact === true"
                                    @change="$store.settings.compact = $event.target.checked; $store.settings.saveSettings(true)"
                                    aria-label="Compact mode toggle">
                                <div
                                    class="w-9 h-5 bg-space-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-gray-600 after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-neon-green peer-checked:after:bg-white">
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Server Configuration -->
            <div x-show="activeTab === 'server'" x-data="window.Components.serverConfig()"
                class="space-y-6 max-w-2xl animate-fade-in pb-10">
                <!-- ðŸ” Security Section -->
                <div class="view-card border-neon-yellow/20 bg-neon-yellow/5">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-10 h-10 rounded-lg bg-neon-yellow/10 flex items-center justify-center text-neon-yellow">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                </svg>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-white mb-0.5"
                                    x-text="$store.global.t('changePassword')">WebUI Password</h4>
                                <p class="text-xs text-gray-500" x-text="$store.global.t('changePasswordDesc')">
                                    Authentication for accessing this dashboard</p>
                            </div>
                        </div>
                        <button
                            class="btn btn-sm border-neon-yellow/30 bg-transparent text-neon-yellow hover:bg-neon-yellow hover:text-black transition-all gap-2"
                            @click="showPasswordDialog()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                            </svg>
                            <span x-text="$store.global.t('changePassword')">Change Password</span>
                        </button>
                    </div>
                </div>

                <!-- âš¡ Common Settings -->
                <div class="space-y-3">
                    <div class="flex items-center gap-2 mb-1 px-1">
                        <span class="text-[10px] uppercase text-gray-500 font-bold tracking-widest"
                            x-text="$store.global.t('runtimeConfig')">Common Settings</span>
                        <div class="h-px flex-1 bg-space-border/30"></div>
                    </div>

                    <!-- Debug Mode -->
                    <div
                        class="form-control view-card border-space-border/50 hover:border-neon-purple/50">
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col gap-1">
                                <span class="text-sm font-medium text-gray-200"
                                    :class="serverConfig.debug ? 'text-neon-purple' : ''"
                                    x-text="$store.global.t('debugMode')">Debug Mode</span>
                                <span class="text-[11px] text-gray-500" x-text="$store.global.t('debugDesc')">Detailed
                                    logging in the Logs tab</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer" :checked="serverConfig.debug === true"
                                    @change="toggleDebug($el.checked)"
                                    aria-label="Debug mode toggle">
                                <div
                                    class="w-9 h-5 bg-space-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-gray-600 after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-neon-purple peer-checked:after:bg-white">
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Token Cache -->
                    <div
                        class="form-control view-card border-space-border/50 hover:border-neon-green/50">
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col gap-1">
                                <span class="text-sm font-medium text-gray-200"
                                    :class="serverConfig.persistTokenCache ? 'text-neon-green' : ''"
                                    x-text="$store.global.t('persistentSessions')">Persist Token Cache</span>
                                <span class="text-[11px] text-gray-500"
                                    x-text="$store.global.t('persistTokenDesc')">Save OAuth tokens to disk for faster
                                    restarts</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer"
                                    :checked="serverConfig.persistTokenCache === true"
                                    @change="toggleTokenCache($el.checked)"
                                    aria-label="Persist token cache toggle">
                                <div
                                    class="w-9 h-5 bg-space-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-gray-600 after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-neon-green peer-checked:after:bg-white">
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- ðŸ”€ Account Selection Strategy -->
                <div class="space-y-3">
                    <div class="flex items-center gap-2 mb-1 px-1">
                        <span class="text-[10px] uppercase text-gray-500 font-bold tracking-widest"
                            x-text="$store.global.t('accountSelectionStrategy')">Account Selection Strategy</span>
                        <div class="h-px flex-1 bg-space-border/30"></div>
                    </div>

                    <div class="form-control view-card border-space-border/50 hover:border-neon-cyan/50">
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col gap-1 flex-1">
                                <span class="text-sm font-medium text-gray-200"
                                    x-text="$store.global.t('selectionStrategy')">Selection Strategy</span>
                                <span class="text-[11px] text-gray-500"
                                    x-text="currentStrategyDescription()">How accounts are selected for requests</span>
                            </div>
                            <select
                                class="select bg-space-800 border-space-border text-gray-200 focus:border-neon-cyan focus:ring-neon-cyan/20 w-64"
                                :value="serverConfig.accountSelection?.strategy || 'hybrid'"
                                @change="toggleStrategy($el.value)"
                                aria-label="Account selection strategy">
                                <option value="hybrid" x-text="$store.global.t('strategyHybridLabel')">Hybrid (Smart Distribution)</option>
                                <option value="sticky" x-text="$store.global.t('strategyStickyLabel')">Sticky (Cache Optimized)</option>
                                <option value="round-robin" x-text="$store.global.t('strategyRoundRobinLabel')">Round Robin (Load Balanced)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- â–¼ Advanced Tuning (Fixed Logic) -->
                <div class="view-card !p-0 border-space-border/50">
                    <div class="flex items-center justify-between p-4 cursor-pointer hover:bg-white/5 transition-colors"
                        @click="advancedExpanded = !advancedExpanded">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded bg-space-800 flex items-center justify-center text-neon-cyan">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                                </svg>
                            </div>
                            <div>
                                <span class="text-sm font-semibold text-gray-200"
                                    x-text="$store.global.t('advancedSettings')">Advanced Settings</span>
                                <span class="text-[10px] text-gray-600 block"
                                    x-text="$store.global.t('serverReadOnly')">Settings managed via config.json</span>
                            </div>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="w-5 h-5 text-gray-600 transition-transform duration-300"
                            :class="advancedExpanded ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>

                    <div x-show="advancedExpanded" x-cloak class="p-5 pt-0 space-y-6">
                        <div class="h-px bg-space-border/20 mb-4"></div>

                        <!-- Network Retry Settings -->
                        <div class="space-y-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest"
                                    x-text="$store.global.t('networkRetry')">Network Retry Settings</span>
                            </div>

                            <div class="form-control">
                                <label class="label pt-0">
                                    <span class="label-text text-gray-400 text-xs"
                                        x-text="$store.global.t('maxRetries')">Max Retries</span>
                                    <span class="label-text-alt font-mono text-neon-purple text-xs font-semibold"
                                        x-text="serverConfig.maxRetries || 5"></span>
                                </label>
                                <div class="flex gap-3 items-center">
                                    <input type="range" min="1" max="20" class="custom-range custom-range-purple flex-1"
                                        :value="serverConfig.maxRetries || 5"
                                        :style="`background-size: ${((serverConfig.maxRetries || 5) - 1) / 19 * 100}% 100%`"
                                        @input="toggleMaxRetries($event.target.value)"
                                        aria-label="Max retries slider">
                                    <input type="number" min="1" max="20"
                                        class="input input-xs input-bordered w-16 bg-space-800 border-space-border text-white font-mono text-center"
                                        :value="serverConfig.maxRetries || 5"
                                        @change="toggleMaxRetries($event.target.value)"
                                        aria-label="Max retries value">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-control">
                                    <label class="label pt-0">
                                        <span class="label-text text-gray-400 text-xs"
                                            x-text="$store.global.t('retryBaseDelay')">Base Delay</span>
                                        <span class="label-text-alt font-mono text-neon-green text-xs font-semibold"
                                            x-text="((serverConfig.retryBaseMs || 1000) < 10000 ? (serverConfig.retryBaseMs || 1000) + 'ms' : Math.round((serverConfig.retryBaseMs || 1000) / 1000) + 's')"></span>
                                    </label>
                                    <div class="flex gap-2 items-center">
                                        <input type="range" min="100" max="10000" step="100"
                                            class="custom-range custom-range-green flex-1"
                                            :value="serverConfig.retryBaseMs || 1000"
                                            :style="`background-size: ${((serverConfig.retryBaseMs || 1000) - 100) / 99}% 100%`"
                                            @input="toggleRetryBaseMs($event.target.value)"
                                            aria-label="Retry base delay slider">
                                        <input type="number" min="100" max="10000" step="100"
                                            class="input input-xs input-bordered w-20 bg-space-800 border-space-border text-white font-mono text-center"
                                            :value="serverConfig.retryBaseMs || 1000"
                                            @change="toggleRetryBaseMs($event.target.value)"
                                            aria-label="Retry base delay value">
                                    </div>
                                </div>
                                <div class="form-control">
                                    <label class="label pt-0">
                                        <span class="label-text text-gray-400 text-xs"
                                            x-text="$store.global.t('retryMaxDelay')">Max Delay</span>
                                        <span class="label-text-alt font-mono text-neon-green text-xs font-semibold"
                                            x-text="Math.round((serverConfig.retryMaxMs || 30000) / 1000) + 's'"></span>
                                    </label>
                                    <div class="flex gap-2 items-center">
                                        <input type="range" min="1000" max="120000" step="1000"
                                            class="custom-range custom-range-green flex-1"
                                            :value="serverConfig.retryMaxMs || 30000"
                                            :style="`background-size: ${((serverConfig.retryMaxMs || 30000) - 1000) / 1190}% 100%`"
                                            @input="toggleRetryMaxMs($event.target.value)"
                                            aria-label="Retry max delay slider">
                                        <input type="number" min="1000" max="120000" step="1000"
                                            class="input input-xs input-bordered w-20 bg-space-800 border-space-border text-white font-mono text-center"
                                            :value="serverConfig.retryMaxMs || 30000"
                                            @change="toggleRetryMaxMs($event.target.value)"
                                            aria-label="Retry max delay value">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Account Rate Limiting -->
                        <div class="space-y-4 pt-2 border-t border-space-border/10">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest"
                                    x-text="$store.global.t('rateLimiting')">Rate Limiting & Timeouts</span>
                            </div>

                            <div class="form-control">
                                <label class="label pt-0">
                                    <span class="label-text text-gray-400 text-xs"
                                        x-text="$store.global.t('defaultCooldown')">Default Cooldown</span>
                                    <span class="label-text-alt font-mono text-neon-cyan text-xs font-semibold"
                                        x-text="Math.round((serverConfig.defaultCooldownMs || 10000) / 1000) + 's'"></span>
                                </label>
                                <div class="flex gap-3 items-center">
                                    <input type="range" min="1000" max="300000" step="1000"
                                        class="custom-range custom-range-cyan flex-1"
                                        :value="serverConfig.defaultCooldownMs || 10000"
                                        :style="`background-size: ${((serverConfig.defaultCooldownMs || 10000) - 1000) / 2990}% 100%`"
                                        @input="toggleDefaultCooldownMs($event.target.value)"
                                        aria-label="Default cooldown slider">
                                    <input type="number" min="1000" max="300000" step="1000"
                                        class="input input-xs input-bordered w-24 bg-space-800 border-space-border text-white font-mono text-center"
                                        :value="serverConfig.defaultCooldownMs || 10000"
                                        @change="toggleDefaultCooldownMs($event.target.value)"
                                        aria-label="Default cooldown value">
                                </div>
                                <p class="text-[9px] text-gray-600 mt-1 leading-tight"
                                    x-text="$store.global.t('defaultCooldownDesc')">Fallback cooldown when API doesn't provide a reset time.</p>
                            </div>

                            <div class="form-control">
                                <label class="label pt-0">
                                    <span class="label-text text-gray-400 text-xs"
                                        x-text="$store.global.t('maxWaitThreshold')">Max Wait Before Error</span>
                                    <span class="label-text-alt font-mono text-neon-cyan text-xs font-semibold"
                                        x-text="((serverConfig.maxWaitBeforeErrorMs || 120000) >= 60000 ? Math.round((serverConfig.maxWaitBeforeErrorMs || 120000) / 60000) + 'm' : Math.round((serverConfig.maxWaitBeforeErrorMs || 120000) / 1000) + 's')"></span>
                                </label>
                                <div class="flex gap-3 items-center">
                                    <input type="range" min="0" max="600000" step="10000"
                                        class="custom-range custom-range-cyan flex-1"
                                        :value="serverConfig.maxWaitBeforeErrorMs || 120000"
                                        :style="`background-size: ${(serverConfig.maxWaitBeforeErrorMs || 120000) / 6000}% 100%`"
                                        @input="toggleMaxWaitBeforeErrorMs($event.target.value)"
                                        aria-label="Max wait before error slider">
                                    <input type="number" min="0" max="600000" step="10000"
                                        class="input input-xs input-bordered w-24 bg-space-800 border-space-border text-white font-mono text-center"
                                        :value="serverConfig.maxWaitBeforeErrorMs || 120000"
                                        @change="toggleMaxWaitBeforeErrorMs($event.target.value)"
                                        aria-label="Max wait before error value">
                                </div>
                                <p class="text-[9px] text-gray-600 mt-1 leading-tight"
                                    x-text="$store.global.t('maxWaitDesc')">If all accounts are rate-limited longer than this, error immediately.</p>
                            </div>
                        </div>

                        <!-- Error Handling Tuning -->
                        <div class="space-y-4 pt-2 border-t border-space-border/10">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest"
                                    x-text="$store.global.t('errorHandlingTuning')">Error Handling Tuning</span>
                            </div>

                            <div class="form-control">
                                <label class="label pt-0">
                                    <span class="label-text text-gray-400 text-xs"
                                        x-text="$store.global.t('rateLimitDedupWindow')">Rate Limit Dedup Window</span>
                                    <span class="label-text-alt font-mono text-neon-cyan text-xs font-semibold"
                                        x-text="Math.round((serverConfig.rateLimitDedupWindowMs || 5000) / 1000) + 's'"></span>
                                </label>
                                <div class="flex gap-3 items-center">
                                    <input type="range" min="1000" max="30000" step="1000"
                                        class="custom-range custom-range-cyan flex-1"
                                        :value="serverConfig.rateLimitDedupWindowMs || 5000"
                                        :style="`background-size: ${((serverConfig.rateLimitDedupWindowMs || 5000) - 1000) / 290}% 100%`"
                                        @input="toggleRateLimitDedupWindowMs($event.target.value)"
                                        aria-label="Rate limit dedup window slider">
                                    <input type="number" min="1000" max="30000" step="1000"
                                        class="input input-xs input-bordered w-20 bg-space-800 border-space-border text-white font-mono text-center"
                                        :value="serverConfig.rateLimitDedupWindowMs || 5000"
                                        @change="toggleRateLimitDedupWindowMs($event.target.value)"
                                        aria-label="Rate limit dedup window value">
                                </div>
                                <p class="text-[9px] text-gray-600 mt-1 leading-tight"
                                    x-text="$store.global.t('rateLimitDedupWindowDesc')">Prevents concurrent retry storms.</p>
                            </div>

                            <div class="form-control">
                                <label class="label pt-0">
                                    <span class="label-text text-gray-400 text-xs"
                                        x-text="$store.global.t('maxConsecutiveFailures')">Max Consecutive Failures</span>
                                    <span class="label-text-alt font-mono text-neon-cyan text-xs font-semibold"
                                        x-text="serverConfig.maxConsecutiveFailures || 3"></span>
                                </label>
                                <div class="flex gap-3 items-center">
                                    <input type="range" min="1" max="10" step="1"
                                        class="custom-range custom-range-cyan flex-1"
                                        :value="serverConfig.maxConsecutiveFailures || 3"
                                        :style="`background-size: ${((serverConfig.maxConsecutiveFailures || 3) - 1) / 0.09}% 100%`"
                                        @input="toggleMaxConsecutiveFailures($event.target.value)"
                                        aria-label="Max consecutive failures slider">
                                    <input type="number" min="1" max="10" step="1"
                                        class="input input-xs input-bordered w-16 bg-space-800 border-space-border text-white font-mono text-center"
                                        :value="serverConfig.maxConsecutiveFailures || 3"
                                        @change="toggleMaxConsecutiveFailures($event.target.value)"
                                        aria-label="Max consecutive failures value">
                                </div>
                                <p class="text-[9px] text-gray-600 mt-1 leading-tight"
                                    x-text="$store.global.t('maxConsecutiveFailuresDesc')">Failures before extended cooldown.</p>
                            </div>

                            <div class="form-control">
                                <label class="label pt-0">
                                    <span class="label-text text-gray-400 text-xs"
                                        x-text="$store.global.t('extendedCooldown')">Extended Cooldown</span>
                                    <span class="label-text-alt font-mono text-neon-cyan text-xs font-semibold"
                                        x-text="((serverConfig.extendedCooldownMs || 60000) >= 60000 ? Math.round((serverConfig.extendedCooldownMs || 60000) / 60000) + 'm' : Math.round((serverConfig.extendedCooldownMs || 60000) / 1000) + 's')"></span>
                                </label>
                                <div class="flex gap-3 items-center">
                                    <input type="range" min="10000" max="300000" step="10000"
                                        class="custom-range custom-range-cyan flex-1"
                                        :value="serverConfig.extendedCooldownMs || 60000"
                                        :style="`background-size: ${((serverConfig.extendedCooldownMs || 60000) - 10000) / 2900}% 100%`"
                                        @input="toggleExtendedCooldownMs($event.target.value)"
                                        aria-label="Extended cooldown slider">
                                    <input type="number" min="10000" max="300000" step="10000"
                                        class="input input-xs input-bordered w-24 bg-space-800 border-space-border text-white font-mono text-center"
                                        :value="serverConfig.extendedCooldownMs || 60000"
                                        @change="toggleExtendedCooldownMs($event.target.value)"
                                        aria-label="Extended cooldown value">
                                </div>
                                <p class="text-[9px] text-gray-600 mt-1 leading-tight"
                                    x-text="$store.global.t('extendedCooldownDesc')">Applied after max consecutive failures.</p>
                            </div>

                            <div class="form-control">
                                <label class="label pt-0">
                                    <span class="label-text text-gray-400 text-xs"
                                        x-text="$store.global.t('capacityRetryDelay')">Capacity Retry Delay</span>
                                    <span class="label-text-alt font-mono text-neon-cyan text-xs font-semibold"
                                        x-text="Math.round((serverConfig.capacityRetryDelayMs || 2000) / 1000) + 's'"></span>
                                </label>
                                <div class="flex gap-3 items-center">
                                    <input type="range" min="500" max="10000" step="500"
                                        class="custom-range custom-range-cyan flex-1"
                                        :value="serverConfig.capacityRetryDelayMs || 2000"
                                        :style="`background-size: ${((serverConfig.capacityRetryDelayMs || 2000) - 500) / 95}% 100%`"
                                        @input="toggleCapacityRetryDelayMs($event.target.value)"
                                        aria-label="Capacity retry delay slider">
                                    <input type="number" min="500" max="10000" step="500"
                                        class="input input-xs input-bordered w-20 bg-space-800 border-space-border text-white font-mono text-center"
                                        :value="serverConfig.capacityRetryDelayMs || 2000"
                                        @change="toggleCapacityRetryDelayMs($event.target.value)"
                                        aria-label="Capacity retry delay value">
                                </div>
                                <p class="text-[9px] text-gray-600 mt-1 leading-tight"
                                    x-text="$store.global.t('capacityRetryDelayDesc')">Delay for capacity (not quota) issues.</p>
                            </div>

                            <div class="form-control">
                                <label class="label pt-0">
                                    <span class="label-text text-gray-400 text-xs"
                                        x-text="$store.global.t('maxCapacityRetries')">Max Capacity Retries</span>
                                    <span class="label-text-alt font-mono text-neon-cyan text-xs font-semibold"
                                        x-text="serverConfig.maxCapacityRetries || 3"></span>
                                </label>
                                <div class="flex gap-3 items-center">
                                    <input type="range" min="1" max="10" step="1"
                                        class="custom-range custom-range-cyan flex-1"
                                        :value="serverConfig.maxCapacityRetries || 3"
                                        :style="`background-size: ${((serverConfig.maxCapacityRetries || 3) - 1) / 0.09}% 100%`"
                                        @input="toggleMaxCapacityRetries($event.target.value)"
                                        aria-label="Max capacity retries slider">
                                    <input type="number" min="1" max="10" step="1"
                                        class="input input-xs input-bordered w-16 bg-space-800 border-space-border text-white font-mono text-center"
                                        :value="serverConfig.maxCapacityRetries || 3"
                                        @change="toggleMaxCapacityRetries($event.target.value)"
                                        aria-label="Max capacity retries value">
                                </div>
                                <p class="text-[9px] text-gray-600 mt-1 leading-tight"
                                    x-text="$store.global.t('maxCapacityRetriesDesc')">Retries before switching accounts.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- â„¹ï¸ Info Notice -->
                <div class="flex items-center gap-3 text-xs text-gray-600 italic pt-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span
                        x-text="$store.global.t('serverRestartAlert', {path: '~/.config/antigravity-proxy/config.json'})">All
                        changes are saved automatically. Some settings may require server restart.</span>
                </div>

                <!-- Password Dialog (Server Tab) -->
                <div x-show="passwordDialog.show"
                    class="fixed inset-0 bg-black/50 flex items-center justify-center z-[9999]"
                    @click.self="hidePasswordDialog()" x-cloak>
                    <div class="bg-space-900 border border-space-border rounded-lg p-6 max-w-md w-full mx-4"
                        @click.stop>
                        <h3 class="text-lg font-bold text-white mb-4" x-text="$store.global.t('changePassword')">Change
                            WebUI Password</h3>

                        <div class="space-y-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text text-gray-300"
                                        x-text="$store.global.t('currentPassword')">Current Password</span>
                                </label>
                                <input type="password" x-model="passwordDialog.oldPassword"
                                    class="input input-sm input-bordered bg-space-800 border-space-border text-white w-full"
                                    :placeholder="$store.global.t('passwordEmptyDesc')"
                                    aria-label="Current password">
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text text-gray-300" x-text="$store.global.t('newPassword')">New
                                        Password</span>
                                </label>
                                <input type="password" x-model="passwordDialog.newPassword"
                                    class="input input-sm input-bordered bg-space-800 border-space-border text-white w-full"
                                    :placeholder="$store.global.t('passwordLengthDesc')"
                                    aria-label="New password">
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text text-gray-300"
                                        x-text="$store.global.t('confirmNewPassword')">Confirm New Password</span>
                                </label>
                                <input type="password" x-model="passwordDialog.confirmPassword"
                                    class="input input-sm input-bordered bg-space-800 border-space-border text-white w-full"
                                    :placeholder="$store.global.t('passwordConfirmDesc')"
                                    @keydown.enter="changePassword()"
                                    aria-label="Confirm new password">
                            </div>
                        </div>

                        <div class="flex justify-end gap-2 mt-6">
                            <button class="btn btn-sm btn-ghost text-gray-400" @click="hidePasswordDialog()"
                                x-text="$store.global.t('cancel')">Cancel</button>
                            <button class="btn btn-sm bg-neon-purple hover:bg-purple-600 border-none text-white"
                                @click="changePassword()" x-text="$store.global.t('changePassword')">
                                Change Password
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: API Keys -->
            <div x-show="activeTab === 'apikeys'" x-data="{
                keys: [],
                loading: true,
                newKeyName: '',
                generatedKey: null,
                showDialog: false,
                async loadKeys() {
                    this.loading = true;
                    try {
                        const res = await fetch('/api/keys');
                        const data = await res.json();
                        this.keys = data.keys || [];
                    } catch (e) {
                        console.error('Failed to load API keys:', e);
                    } finally {
                        this.loading = false;
                    }
                },
                async generateKey() {
                    if (!this.newKeyName.trim()) {
                        this.newKeyName = 'Unnamed Key';
                    }
                    try {
                        const res = await fetch('/api/keys', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: this.newKeyName })
                        });
                        const data = await res.json();
                        if (data.status === 'ok') {
                            this.generatedKey = data.key.key;
                            this.showDialog = true;
                            this.newKeyName = '';
                            await this.loadKeys();
                        }
                    } catch (e) {
                        console.error('Failed to generate API key:', e);
                        $store.global.showToast('Failed to generate API key', 'error');
                    }
                },
                async toggleKey(id, enabled) {
                    try {
                        await fetch(`/api/keys/${id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ enabled })
                        });
                        await this.loadKeys();
                    } catch (e) {
                        console.error('Failed to toggle API key:', e);
                    }
                },
                async deleteKey(id) {
                    if (!confirm('Are you sure you want to delete this API key?')) return;
                    try {
                        await fetch(`/api/keys/${id}`, { method: 'DELETE' });
                        await this.loadKeys();
                        $store.global.showToast('API key deleted', 'success');
                    } catch (e) {
                        console.error('Failed to delete API key:', e);
                    }
                },
                copyKey() {
                    navigator.clipboard.writeText(this.generatedKey);
                    $store.global.showToast('API key copied to clipboard', 'success');
                },
                formatDate(ts) {
                    if (!ts) return 'Never';
                    return new Date(ts).toLocaleDateString();
                }
            }" x-init="loadKeys()" class="space-y-6 max-w-3xl animate-fade-in pb-10">

                <!-- Header with Generate Button -->
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="text-lg font-bold text-white">API Keys</h4>
                        <p class="text-sm text-gray-500">Manage API keys for OpenAI-compatible access</p>
                    </div>
                    <div class="flex gap-2 items-center">
                        <input type="text" x-model="newKeyName" placeholder="Key name (optional)"
                            class="input input-sm input-bordered bg-space-800 border-space-border text-white w-48"
                            @keydown.enter="generateKey()">
                        <button @click="generateKey()"
                            class="btn btn-sm bg-neon-purple hover:bg-purple-600 border-none text-white gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Generate Key
                        </button>
                    </div>
                </div>

                <!-- Info Alert -->
                <div class="alert bg-space-900/50 border-space-border text-sm shadow-none">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-info shrink-0 w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-gray-400">
                        <p class="font-medium text-gray-300">OpenAI-Compatible API</p>
                        <p class="text-xs mt-1">Use these keys with <code class="text-neon-cyan">POST /v1/chat/completions</code> endpoint. Compatible with OpenAI SDK, LangChain, Cursor, and more.</p>
                    </div>
                </div>

                <!-- Keys List -->
                <div class="view-card !p-0 overflow-hidden">
                    <template x-if="loading">
                        <div class="p-8 text-center text-gray-500">
                            <span class="loading loading-spinner loading-md"></span>
                        </div>
                    </template>

                    <template x-if="!loading && keys.length === 0">
                        <div class="p-8 text-center">
                            <div class="w-16 h-16 rounded-full bg-space-800 flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                                </svg>
                            </div>
                            <p class="text-gray-400 font-medium">No API Keys</p>
                            <p class="text-gray-600 text-sm mt-1">Generate a key to enable API access</p>
                        </div>
                    </template>

                    <template x-if="!loading && keys.length > 0">
                        <table class="table w-full">
                            <thead class="bg-space-900/50">
                                <tr>
                                    <th class="text-gray-500 font-medium text-xs uppercase">Name</th>
                                    <th class="text-gray-500 font-medium text-xs uppercase">Key</th>
                                    <th class="text-gray-500 font-medium text-xs uppercase">Created</th>
                                    <th class="text-gray-500 font-medium text-xs uppercase">Last Used</th>
                                    <th class="text-gray-500 font-medium text-xs uppercase">Requests</th>
                                    <th class="text-gray-500 font-medium text-xs uppercase">Status</th>
                                    <th class="text-gray-500 font-medium text-xs uppercase text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="key in keys" :key="key.id">
                                    <tr class="hover:bg-white/5">
                                        <td class="font-medium text-white" x-text="key.name"></td>
                                        <td>
                                            <code class="text-neon-cyan text-xs font-mono bg-space-800 px-2 py-1 rounded" x-text="key.keyMasked"></code>
                                        </td>
                                        <td class="text-gray-400 text-sm" x-text="formatDate(key.createdAt)"></td>
                                        <td class="text-gray-400 text-sm" x-text="formatDate(key.lastUsed)"></td>
                                        <td class="text-gray-400 text-sm font-mono" x-text="key.requestCount || 0"></td>
                                        <td>
                                            <span class="badge badge-sm"
                                                :class="key.enabled ? 'badge-success' : 'badge-error'"
                                                x-text="key.enabled ? 'Active' : 'Disabled'"></span>
                                        </td>
                                        <td class="text-right">
                                            <div class="flex gap-2 justify-end">
                                                <button @click="toggleKey(key.id, !key.enabled)"
                                                    class="btn btn-xs btn-ghost"
                                                    :class="key.enabled ? 'text-neon-yellow' : 'text-neon-green'">
                                                    <span x-text="key.enabled ? 'Disable' : 'Enable'"></span>
                                                </button>
                                                <button @click="deleteKey(key.id)"
                                                    class="btn btn-xs btn-ghost text-red-400 hover:text-red-300">
                                                    Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </template>
                </div>

                <!-- Usage Example -->
                <div class="view-card border-space-border/50">
                    <h5 class="text-sm font-bold text-white mb-3">Usage Example</h5>
                    <pre class="bg-space-900 rounded-lg p-4 text-xs overflow-x-auto"><code class="text-gray-300">from openai import OpenAI

client = OpenAI(
    base_url="<span class="text-neon-cyan">http://localhost:8080/v1</span>",
    api_key="<span class="text-neon-purple">your-api-key</span>"
)

response = client.chat.completions.create(
    model="<span class="text-neon-green">gpt-4</span>",  # Maps to claude-opus-4-5-thinking
    messages=[{"role": "user", "content": "Hello!"}]
)</code></pre>
                </div>

                <!-- Generated Key Dialog -->
                <div x-show="showDialog"
                    class="fixed inset-0 bg-black/50 flex items-center justify-center z-[9999]"
                    @click.self="showDialog = false" x-cloak>
                    <div class="bg-space-900 border border-space-border rounded-lg p-6 max-w-lg w-full mx-4" @click.stop>
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full bg-neon-green/20 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-neon-green" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">API Key Generated</h3>
                                <p class="text-xs text-gray-500">Copy this key now - you won't see it again!</p>
                            </div>
                        </div>

                        <div class="bg-space-800 rounded-lg p-4 mb-4">
                            <code class="text-neon-cyan text-sm font-mono break-all" x-text="generatedKey"></code>
                        </div>

                        <div class="flex justify-end gap-2">
                            <button class="btn btn-sm btn-ghost text-gray-400" @click="showDialog = false">Close</button>
                            <button class="btn btn-sm bg-neon-purple hover:bg-purple-600 border-none text-white gap-2" @click="copyKey()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                                Copy Key
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>