<div x-data="apiKeys" x-init="init()" class="view-container">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-white">API Keys</h1>
            <p class="text-gray-400 text-sm mt-1">Manage API keys with advanced restrictions</p>
        </div>
        <button @click="openCreateDialog()" class="btn btn-primary btn-sm gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Create Key
        </button>
    </div>

    <!-- Search -->
    <div class="mb-4">
        <input type="text" x-model="searchQuery" placeholder="Search keys..."
            class="input input-bordered input-sm w-full max-w-xs bg-space-800 border-space-border" />
    </div>

    <!-- Loading -->
    <template x-if="loading">
        <div class="flex justify-center py-12">
            <span class="loading loading-spinner loading-lg text-primary"></span>
        </div>
    </template>

    <!-- Empty State -->
    <template x-if="!loading && keys.length === 0">
        <div class="text-center py-12">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-gray-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
            </svg>
            <h3 class="text-lg font-semibold text-gray-300 mb-2">No API Keys</h3>
            <p class="text-gray-500 mb-4">Create your first API key to get started</p>
            <button @click="openCreateDialog()" class="btn btn-primary btn-sm">Create API Key</button>
        </div>
    </template>

    <!-- Keys Table -->
    <template x-if="!loading && keys.length > 0">
        <div class="overflow-x-auto">
            <table class="table table-zebra w-full">
                <thead>
                    <tr class="text-gray-400">
                        <th>Name</th>
                        <th>Key</th>
                        <th>Restrictions</th>
                        <th>Usage</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="key in filteredKeys" :key="key.id">
                        <tr class="hover">
                            <td>
                                <div class="font-medium text-white" x-text="key.name"></div>
                                <div class="text-xs text-gray-500" x-text="formatDate(key.created_at)"></div>
                            </td>
                            <td>
                                <code class="text-xs text-cyan-400 bg-space-800 px-2 py-1 rounded" x-text="key.key_prefix"></code>
                            </td>
                            <td class="text-sm">
                                <div x-show="key.allowed_models" class="text-xs text-gray-400">
                                    <span class="font-medium">Models:</span>
                                    <span x-text="key.allowed_models ? key.allowed_models.join(', ') : 'All'"></span>
                                </div>
                                <div x-show="key.rate_limit_rpm || key.rate_limit_rph" class="text-xs text-gray-400">
                                    <span class="font-medium">Rate:</span>
                                    <span x-show="key.rate_limit_rpm" x-text="key.rate_limit_rpm + '/min'"></span>
                                    <span x-show="key.rate_limit_rpm && key.rate_limit_rph">, </span>
                                    <span x-show="key.rate_limit_rph" x-text="key.rate_limit_rph + '/hr'"></span>
                                </div>
                                <div x-show="key.ip_whitelist" class="text-xs text-gray-400">
                                    <span class="font-medium">IPs:</span>
                                    <span x-text="key.ip_whitelist ? key.ip_whitelist.length + ' allowed' : ''"></span>
                                </div>
                                <div x-show="!key.allowed_models && !key.rate_limit_rpm && !key.rate_limit_rph && !key.ip_whitelist" class="text-xs text-gray-500">
                                    No restrictions
                                </div>
                            </td>
                            <td>
                                <div class="text-sm" x-text="key.request_count + ' requests'"></div>
                                <div class="text-xs text-gray-500" x-text="'Last: ' + formatDate(key.last_used_at)"></div>
                            </td>
                            <td>
                                <span x-show="!key.enabled" class="badge badge-error badge-sm">Disabled</span>
                                <span x-show="key.enabled && isExpired(key)" class="badge badge-warning badge-sm">Expired</span>
                                <span x-show="key.enabled && !isExpired(key) && getExpirationStatus(key) === 'expiring-soon'" class="badge badge-warning badge-sm">Expiring Soon</span>
                                <span x-show="key.enabled && !isExpired(key) && getExpirationStatus(key) !== 'expiring-soon'" class="badge badge-success badge-sm">Active</span>
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <button @click="openEditDialog(key)" class="btn btn-ghost btn-xs" title="Edit">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                    </button>
                                    <button @click="toggleKey(key)" class="btn btn-ghost btn-xs" :title="key.enabled ? 'Disable' : 'Enable'">
                                        <svg x-show="key.enabled" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        <svg x-show="!key.enabled" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </button>
                                    <button @click="regenerateKey(key)" class="btn btn-ghost btn-xs" title="Regenerate">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                        </svg>
                                    </button>
                                    <button @click="deleteKey(key)" class="btn btn-ghost btn-xs text-red-400" title="Delete">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </template>

    <!-- Create/Generated Key Dialog -->
    <dialog :open="showCreateDialog" class="modal modal-open" x-show="showCreateDialog" x-cloak>
        <div class="modal-box bg-space-800 max-w-lg">
            <!-- Show generated key -->
            <template x-if="generatedKey">
                <div>
                    <h3 class="font-bold text-lg text-green-400 mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        API Key Created!
                    </h3>
                    <div class="alert alert-warning mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <span class="text-sm">Copy this key now! You won't see it again.</span>
                    </div>
                    <div class="bg-space-900 rounded-lg p-4 mb-4">
                        <code class="text-cyan-400 text-sm break-all" x-text="generatedKey"></code>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button @click="copyKey(generatedKey)" class="btn btn-primary btn-sm">Copy to Clipboard</button>
                        <button @click="closeCreateDialog()" class="btn btn-ghost btn-sm">Close</button>
                    </div>
                </div>
            </template>

            <!-- Create form -->
            <template x-if="!generatedKey">
                <form @submit.prevent="createKey()">
                    <h3 class="font-bold text-lg text-white mb-4">Create API Key</h3>

                    <div class="form-control mb-3">
                        <label class="label"><span class="label-text">Name *</span></label>
                        <input type="text" x-model="newKey.name" placeholder="My API Key" class="input input-bordered input-sm bg-space-900" required />
                    </div>

                    <div class="form-control mb-3">
                        <label class="label">
                            <span class="label-text">Allowed Models</span>
                            <span class="label-text-alt text-gray-500">
                                <span x-text="newKey.allowed_models.length === 0 ? 'All models allowed' : newKey.allowed_models.length + ' selected'"></span>
                            </span>
                        </label>
                        <div class="relative" @click.away="showModelDropdown = false">
                            <button type="button" @click="showModelDropdown = !showModelDropdown"
                                class="input input-bordered input-sm bg-space-900 w-full text-left flex items-center justify-between">
                                <span class="truncate" x-text="newKey.allowed_models.length === 0 ? 'All models (click to restrict)' : newKey.allowed_models.join(', ')"></span>
                                <svg class="h-4 w-4 text-gray-400 shrink-0" :class="{ 'rotate-180': showModelDropdown }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div x-show="showModelDropdown" x-transition
                                class="absolute z-50 mt-1 w-full bg-space-900 border border-space-border rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                <div class="sticky top-0 bg-space-900 border-b border-space-border px-3 py-2 flex gap-2">
                                    <button type="button" @click="selectAllModels()" class="btn btn-xs btn-ghost">Select All</button>
                                    <button type="button" @click="clearAllModels()" class="btn btn-xs btn-ghost">Clear All</button>
                                </div>
                                <template x-for="model in availableModels" :key="model">
                                    <label class="flex items-center px-3 py-2 hover:bg-space-700 cursor-pointer">
                                        <input type="checkbox" :checked="isModelSelected(model)" @change="toggleModel(model)"
                                            class="checkbox checkbox-sm checkbox-primary mr-3" />
                                        <span class="text-sm" x-text="model"></span>
                                    </label>
                                </template>
                                <template x-if="availableModels.length === 0">
                                    <div class="px-3 py-4 text-center text-gray-500 text-sm">
                                        No models available. Add an account first.
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="form-control">
                            <label class="label"><span class="label-text">Rate Limit (per minute)</span></label>
                            <input type="number" x-model="newKey.rate_limit_rpm" placeholder="60" min="1" class="input input-bordered input-sm bg-space-900" />
                        </div>
                        <div class="form-control">
                            <label class="label"><span class="label-text">Rate Limit (per hour)</span></label>
                            <input type="number" x-model="newKey.rate_limit_rph" placeholder="1000" min="1" class="input input-bordered input-sm bg-space-900" />
                        </div>
                    </div>

                    <div class="form-control mb-3">
                        <label class="label">
                            <span class="label-text">IP Whitelist</span>
                            <span class="label-text-alt text-gray-500">Comma-separated, supports wildcards</span>
                        </label>
                        <input type="text" x-model="newKey.ip_whitelist" placeholder="192.168.1.*, 10.0.0.1" class="input input-bordered input-sm bg-space-900" />
                    </div>

                    <div class="form-control mb-3">
                        <label class="label"><span class="label-text">Expiration Date</span></label>
                        <input type="datetime-local" x-model="newKey.expires_at" class="input input-bordered input-sm bg-space-900" />
                    </div>

                    <div class="form-control mb-4">
                        <label class="label"><span class="label-text">Notes</span></label>
                        <textarea x-model="newKey.notes" placeholder="Optional notes about this key" class="textarea textarea-bordered textarea-sm bg-space-900" rows="2"></textarea>
                    </div>

                    <div class="flex justify-end gap-2">
                        <button type="button" @click="closeCreateDialog()" class="btn btn-ghost btn-sm">Cancel</button>
                        <button type="submit" class="btn btn-primary btn-sm" :disabled="creating">
                            <span x-show="creating" class="loading loading-spinner loading-xs"></span>
                            Create Key
                        </button>
                    </div>
                </form>
            </template>
        </div>
        <form method="dialog" class="modal-backdrop" @click="closeCreateDialog()">
            <button>close</button>
        </form>
    </dialog>

    <!-- Edit Dialog -->
    <dialog :open="showEditDialog" class="modal modal-open" x-show="showEditDialog" x-cloak>
        <div class="modal-box bg-space-800 max-w-lg" x-show="editingKey">
            <form @submit.prevent="saveKey()">
                <h3 class="font-bold text-lg text-white mb-4">Edit API Key</h3>

                <div class="form-control mb-3">
                    <label class="label"><span class="label-text">Name *</span></label>
                    <input type="text" x-model="editingKey.name" class="input input-bordered input-sm bg-space-900" required />
                </div>

                <div class="form-control mb-3">
                    <label class="label">
                        <span class="label-text">Allowed Models</span>
                        <span class="label-text-alt text-gray-500">
                            <span x-text="editingKey.allowed_models_arr?.length === 0 ? 'All models allowed' : (editingKey.allowed_models_arr?.length || 0) + ' selected'"></span>
                        </span>
                    </label>
                    <div class="relative" @click.away="showEditModelDropdown = false">
                        <button type="button" @click="showEditModelDropdown = !showEditModelDropdown"
                            class="input input-bordered input-sm bg-space-900 w-full text-left flex items-center justify-between">
                            <span class="truncate" x-text="editingKey.allowed_models_arr?.length === 0 ? 'All models (click to restrict)' : editingKey.allowed_models_arr?.join(', ')"></span>
                            <svg class="h-4 w-4 text-gray-400 shrink-0" :class="{ 'rotate-180': showEditModelDropdown }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div x-show="showEditModelDropdown" x-transition
                            class="absolute z-50 mt-1 w-full bg-space-900 border border-space-border rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            <div class="sticky top-0 bg-space-900 border-b border-space-border px-3 py-2 flex gap-2">
                                <button type="button" @click="selectAllEditModels()" class="btn btn-xs btn-ghost">Select All</button>
                                <button type="button" @click="clearAllEditModels()" class="btn btn-xs btn-ghost">Clear All</button>
                            </div>
                            <template x-for="model in availableModels" :key="model">
                                <label class="flex items-center px-3 py-2 hover:bg-space-700 cursor-pointer">
                                    <input type="checkbox" :checked="isEditModelSelected(model)" @change="toggleEditModel(model)"
                                        class="checkbox checkbox-sm checkbox-primary mr-3" />
                                    <span class="text-sm" x-text="model"></span>
                                </label>
                            </template>
                            <template x-if="availableModels.length === 0">
                                <div class="px-3 py-4 text-center text-gray-500 text-sm">
                                    No models available. Add an account first.
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="form-control">
                        <label class="label"><span class="label-text">Rate Limit (per minute)</span></label>
                        <input type="number" x-model="editingKey.rate_limit_rpm" placeholder="Unlimited" min="1" class="input input-bordered input-sm bg-space-900" />
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Rate Limit (per hour)</span></label>
                        <input type="number" x-model="editingKey.rate_limit_rph" placeholder="Unlimited" min="1" class="input input-bordered input-sm bg-space-900" />
                    </div>
                </div>

                <div class="form-control mb-3">
                    <label class="label"><span class="label-text">IP Whitelist</span></label>
                    <input type="text" x-model="editingKey.ip_whitelist_str" placeholder="Leave empty for all IPs" class="input input-bordered input-sm bg-space-900" />
                </div>

                <div class="form-control mb-3">
                    <label class="label"><span class="label-text">Expiration Date</span></label>
                    <input type="datetime-local" x-model="editingKey.expires_at_str" class="input input-bordered input-sm bg-space-900" />
                </div>

                <div class="form-control mb-4">
                    <label class="label"><span class="label-text">Notes</span></label>
                    <textarea x-model="editingKey.notes" class="textarea textarea-bordered textarea-sm bg-space-900" rows="2"></textarea>
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button" @click="closeEditDialog()" class="btn btn-ghost btn-sm">Cancel</button>
                    <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop" @click="closeEditDialog()">
            <button>close</button>
        </form>
    </dialog>
</div>
